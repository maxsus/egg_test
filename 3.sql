-- Напиши SQL-запрос
-- Имеем следующие таблицы:
--     1. users — контрагенты
--         1. id
--         2. name
--         3. phone
--         4. email
--         5. created — дата создания записи
--     2. orders — заказы
--         1. id
--         2. subtotal — сумма всех товарных позиций
--         3. created — дата и время поступления заказа (Y-m-d H:i:s)
--         4. city_id — город доставки
--         5. user_id
-- 
-- Необходимо выбрать одним запросом список контрагентов в следующем формате (следует учесть, что будет включена опция only_full_group_by в MySql):
--     1. Имя контрагента
--     2. Его телефон
--     3. Сумма всех его заказов
--     4. Его средний чек
--     5. Дата последнего заказа


CREATE TABLE users (
    id INT AUTO_INCREMENT PRIMARY KEY,
    name VARCHAR(100),
    phone BIGINT,
    email VARCHAR(50),
    created TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);


CREATE TABLE orders (
    id INT AUTO_INCREMENT PRIMARY KEY,
    subtotal INT,
    created DATETIME,
    city_id INT,
    user_id INT,
    name VARCHAR(100)
);


ALTER TABLE orders
ADD FOREIGN KEY (user_id) REFERENCES users(id);


INSERT INTO users (name, phone, email) VALUES
('Имя01', 79999999990, 'email01@example.com'),
('Имя02', 79999999991, 'email02@example.com'),
('Имя03', 79999999992, 'email03@example.com'),
('Имя04', 79999999993, 'email04@example.com'),
('Имя05', 79999999994, 'email05@example.com'),
('Имя06', 79999999995, 'email06@example.com'),
('Имя07', 79999999996, 'email07@example.com'),
('Имя08', 79999999997, 'email08@example.com'),
('Имя09', 79999999998, 'email09@example.com'),
('Имя10', 79999999999, 'email10@example.com');


INSERT INTO orders (subtotal, created, city_id, user_id, name) VALUES
(100.50, '2023-01-01 08:00:00', 15, 1, 'Заказ 1'),
(75.25, '2023-01-02 10:30:00', 42, 3, 'Заказ 2'),
(150.75, '2023-01-03 12:45:00', 67, 5, 'Заказ 3'),
(80.20, '2023-01-04 15:20:00', 23, 7, 'Заказ 4'),
(120.60, '2023-01-05 18:10:00', 89, 9, 'Заказ 5'),
(90.75, '2023-01-06 20:45:00', 34, 2, 'Заказ 6'),
(110.40, '2023-01-07 22:30:00', 56, 4, 'Заказ 7'),
(95.80, '2023-01-08 09:15:00', 78, 6, 'Заказ 8'),
(130.25, '2023-01-09 11:30:00', 12, 8, 'Заказ 9'),
(70.90, '2023-01-10 14:00:00', 45, 10, 'Заказ 10'),
(105.30, '2023-01-11 16:30:00', 60, 1, 'Заказ 11'),
(85.60, '2023-01-12 18:45:00', 25, 3, 'Заказ 12'),
(125.40, '2023-01-13 21:20:00', 80, 5, 'Заказ 13'),
(99.75, '2023-01-14 09:40:00', 15, 7, 'Заказ 14'),
(115.20, '2023-01-15 12:10:00', 34, 9, 'Заказ 15'),
(78.90, '2023-01-16 14:45:00', 56, 2, 'Заказ 16'),
(135.10, '2023-01-17 17:30:00', 78, 4, 'Заказ 17'),
(88.40, '2023-01-18 19:15:00', 23, 6, 'Заказ 18'),
(105.75, '2023-01-19 22:00:00', 45, 8, 'Заказ 19'),
(92.30, '2023-01-20 10:30:00', 67, 10, 'Заказ 20'),
(120.50, '2023-01-21 12:45:00', 34, 1, 'Заказ 21'),
(82.25, '2023-01-22 15:20:00', 56, 3, 'Заказ 22'),
(140.75, '2023-01-23 18:10:00', 78, 5, 'Заказ 23'),
(95.20, '2023-01-24 20:45:00', 12, 7, 'Заказ 24'),
(110.60, '2023-01-25 22:30:00', 45, 9, 'Заказ 25'),
(75.75, '2023-01-26 09:15:00', 67, 2, 'Заказ 26'),
(130.40, '2023-01-27 11:30:00', 89, 4, 'Заказ 27'),
(87.80, '2023-01-28 14:00:00', 23, 6, 'Заказ 28'),
(115.25, '2023-01-29 16:30:00', 56, 8, 'Заказ 29'),
(100.90, '2023-01-30 18:45:00', 78, 10, 'Заказ 30');


SELECT 
    users.name as 'Имя контрагента', 
    users.phone  as 'Телефон', 
    SUM(orders.id) as 'Кол-во заказов',
    AVG(orders.subtotal) as 'Средний чек',
    MAX(orders.created) as 'Дата последнего заказа'
FROM users
INNER JOIN orders on users.id = orders.user_id
GROUP BY users.name, users.phone;